/*! Facetly - v0.1.0 - 2013-06-25
* https://github.com/jiabin/facetly
* Copyright (c) 2013 Eymen Gunay; Licensed MIT */

var Facetly=Facetly||function(e){var t={},a={},n={},s={},o={},r={},l={},d={};t={settings:{debug:!1,selector:"#facetly",elasticsearch:"http://localhost:9200",index:"twitter",type:"tweets",perPage:50,currentPage:1,meta:{},onSerialize:function(){},init:function(a){c("Initializing Settings"),e('meta[name^="facetly-"]').each(function(){t.settings.meta[this.name.replace("facetly-","")]=this.content}),t.settings=t.extend(t.settings,a),u=e(t.settings.selector),c("Initialized Settings")}},cache:{window:window,document:document},extend:function(t,a){return e.extend(t,a)},deepExtend:function(e,t){return deepExtend({},e,t)},elastic_url:function(){return t.settings.elasticsearch},elastic_search_url:function(){return t.elastic_url()},log:function(e){t.settings.debug&&console.log(e)},parseRoute:function(e){var a=e.delimiter||"/",i=e.path.split(a),n=e.target[i.shift()],s=n!==void 0,o=0==i.length;e.inits=e.inits||[],s?("function"==typeof n.init&&e.inits.push(n.init),o?e.parsed.call(void 0,{exists:!0,type:typeof n,obj:n,inits:e.inits}):t.parseRoute({path:i.join(a),target:n,delimiter:a,parsed:e.parsed,inits:e.inits})):e.parsed.call(void 0,{exists:!1})},route:function(){t.parseRoute({path:t.settings.meta.route,target:Routes,delimiter:"/",parsed:function(e){if(e.exists&&"function"==e.type){if(0!=e.inits.length)for(var t in e.inits)e.inits[t].call();e.obj.call()}}})}};var c=t.log;a={send:function(t,a,i,n){e.ajax({type:t,url:a,dataType:"json",data:i,success:n})},call:function(e,t,i){a.send("POST",e,t,i)},get:function(e,t,i){a.send("GET",e,t,i)}},n={endpoints:{serializeTerms:function(){var t=e(this).attr("data-name"),a=e("#facetly-form ul#facet-"+t+" :input").serializeObject();r.holder[t]={};var i=0;for(q in a[t])if(""!=a[t][q].operator&&""!=a[t][q].value){void 0==r.holder[t].bool&&(r.holder[t].bool={}),void 0==r.holder[t].bool[a[t][q].operator]&&(r.holder[t].bool[a[t][q].operator]=[]);var n={};n.wildcard={},n.wildcard[t]=a[t][q].value,r.holder[t].bool[a[t][q].operator].push(n),i++}l.loadResults()},serializeNested:function(){var a=e(this).attr("data-name"),i=e("#facetly-form ul#facet-"+a+" :input").serializeObject(),n=t.settings.facets[a].nested,s=t.settings.facets[a].terms.field?t.settings.facets[a].terms.field:t.settings.facets[a].terms.script_field;r.holder[a]={};var o=0;for(q in i[a])if(""!=i[a][q].operator&&""!=i[a][q].value){void 0==r.holder[a].bool&&(r.holder[a].bool={}),void 0==r.holder[a].bool[i[a][q].operator]&&(r.holder[a].bool[i[a][q].operator]=[]);var d={};d.nested={path:n,query:{wildcard:{}}},d.nested.query.wildcard[s]=i[a][q].value,r.holder[a].bool[i[a][q].operator].push(d),o++}l.loadResults()},clone:function(){var a=e(this).closest("li"),i=e(a).clone(),s=e(this).attr("data-name");i.find("*").removeAttr("data-bound");var o=t.cache.window.tmp[s];void 0===o?t.cache.window.tmp[s]=e("ul#facet-"+s+" select").length:t.cache.window.tmp[s]++;var r=i.find("input").attr("name").replace(/[0-9]+/,t.cache.window.tmp[s]);i.find("input").attr("name",r);var l=i.find("select").attr("name").replace(/[0-9]+/,t.cache.window.tmp[s]);i.find("select").attr("name",l),e(a).after(i),n.bindEvents()},remove:function(){var t=e(this).closest("li"),a=e(t).parent();return 1==e("li.custom",a).length?!1:(e(t).remove(),n.bindEvents(),void 0)}},serialize:function(){var e={};for(i in r.holder)e=t.deepExtend(e,r.holder[i]);var a={query:jQuery.isEmptyObject(e)?r.matchAllQuery():e,size:t.settings.perPage},n=r.create(jQuery.isEmptyObject(e)?r.matchAllQuery():e);return t.settings.onSerialize&&t.settings.onSerialize(a,n),a},bindEvents:function(){c("Binding Events"),e("[data-event]").each(function(){var a=this,i=a.dataset.method||"click",s=a.dataset.event,o=a.dataset.bound;o||t.parseRoute({path:s,target:n.endpoints,delimiter:".",parsed:function(t){t.exists&&(a.dataset.bound=!0,e(a).on(i,function(e){t.obj.call(a,e)}))}})}),c("Events Bound")},init:function(){n.bindEvents()}},s={init:function(){c("Compiling templates"),s.types.terms=Handlebars.compile(s.types.terms),s.types.nested=Handlebars.compile(s.types.nested),Handlebars.registerHelper("random",function(){var e=String.fromCharCode(65+Math.floor(26*Math.random())),t=e+Date.now();return t}),Handlebars.registerHelper("inc",function(e){return e+1}),Handlebars.registerHelper("type",function(e,a){var i=s.types[e._type];return void 0!=t.settings.facets[a].nested&&(i=s.types.nested),new Handlebars.SafeString(i({facet:e,name:a}))}),Handlebars.registerHelper("facets",function(e,a){return a.fn(t.settings.facets[e])}),Handlebars.registerHelper("thead",function(e){var t="<tr>";for(i in e.hits.hits){for(key in e.hits.hits[i]._source)t+="<th>"+key+"</th>";break}return t+="</tr>",new Handlebars.SafeString(t)}),Handlebars.registerHelper("json",function(e){return"object"==typeof e?JSON.stringify(e):e}),s.facets=Handlebars.compile(s.facets),s.results=Handlebars.compile(s.results),c("Templates Compiled")},types:{nested:'<ul id="facet-{{name}}">                 <li class="custom">                     <select class="input-medium" name="{{name}}[0][operator]" data-type="operator" data-name="{{name}}" data-event="serializeNested" data-method="change">                         <option value=""></option>                         <option value="must">Must</option>                         <option value="should">Should</option>                         <option value="must_not">Must Not</option>                     </select>                     <div class="input-append">                         <input class="input-medium" name="{{name}}[0][value]" type="text" data-name="{{name}}" data-type="value" data-event="serializeNested" data-method="keyup">                         <a href="javascript:void()" class="add-on" data-event="clone" data-name="{{name}}" data-method="click"><i class="icon-plus"></i></a>                         <a href="javascript:void()" class="add-on" data-event="remove" data-name="{{name}}" data-method="click"><i class="icon-remove"></i></a>                     </div>                 </li>                 {{#each facet.terms}}                     <li>                         <select class="input-medium" name="{{../name}}[{{inc @index}}][operator]" data-name="{{../name}}" data-event="serializeNested" data-method="change">                             <option value=""></option>                             <option value="must">Must</option>                             <option value="should">Should</option>                             <option value="must_not">Must Not</option>                         </select>                         <input class="input-medium" type="text" value="{{this.term}}" name="{{../name}}[{{inc @index}}][value]" readonly="readonly" data-event="serializeNested" data-method="keyup">                         <small>({{this.count}})</small>                     </li>                 {{/each}}             </ul>',terms:'<ul id="facet-{{name}}">                 <li class="custom">                     <select class="input-medium" name="{{name}}[0][operator]" data-type="operator" data-name="{{name}}" data-event="serializeTerms" data-method="change">                         <option value=""></option>                         <option value="must">Must</option>                         <option value="should">Should</option>                         <option value="must_not">Must Not</option>                     </select>                     <div class="input-append">                         <input class="input-medium" name="{{name}}[0][value]" type="text" data-name="{{name}}" data-type="value" data-event="serializeTerms" data-method="keyup">                         <a href="javascript:void()" class="add-on" data-event="clone" data-name="{{name}}" data-method="click"><i class="icon-plus"></i></a>                         <a href="javascript:void()" class="add-on" data-event="remove" data-name="{{name}}" data-method="click"><i class="icon-remove"></i></a>                     </div>                 </li>                 {{#each facet.terms}}                     <li>                         <select class="input-medium" name="{{../name}}[{{inc @index}}][operator]" data-name="{{../name}}" data-event="serializeTerms" data-method="change">                             <option value=""></option>                             <option value="must">Must</option>                             <option value="should">Should</option>                             <option value="must_not">Must Not</option>                         </select>                         <input class="input-medium" type="text" value="{{this.term}}" name="{{../name}}[{{inc @index}}][value]" readonly="readonly" data-event="serializeTerms" data-method="keyup">                         <small>({{this.count}})</small>                     </li>                 {{/each}}             </ul>'},results:'<div class="results">             <table class="table table-striped table-bordered">                 <thead>                     {{thead results}}                 </thead>                 <tbody>                     {{#each results.hits.hits}}                     <tr>                         {{#each this._source}}                             <td>{{json this}}</td>                         {{/each}}                     </tr>                     {{else}}                     <tr>                         <td>No results found</td>                     </tr>                     {{/each}}                 </tbody>             </table>             <p>{{results.hits.total}} results found</p>         </div>',facets:'<form id="facetly-form">             <ul>                 {{#each facets}}                     <li>                         <div class="header">                             {{@key}}                             <small>Total: {{this.total}}</small>                             <small>Other: {{this.other}}</small>                         </div>                         <div class="content">                             {{type this @key}}                         </div>                     </li>                 {{/each}}             </ul>         </form>         <script>         $( "'+t.settings.selector+' ul" ).accordion({             header: "> li > .header",             heightStyle: "content"         });         </script>'},o={init:function(){o.sidebar=Handlebars.compile(o.sidebar),o.sidebar=e(o.sidebar()),o.results=Handlebars.compile(o.results),o.results=e(o.results()),u.append(o.sidebar),u.append(o.results)},sidebar:'<div class="sidebar"></div>',results:'<div class="results"></div>'},r={create:function(e){return JSON.stringify(e)},matchAllQuery:function(){var e={};return e.match_all={},e},holder:{},search:!1,facets:!1},l={logic:{},init:function(e){c("Initializing Facetly"),t.settings.init(e),o.init(),s.init(),c("Initialized Facetly"),t.cache.window.tmp={},l.loadFacets(function(){n.init()}),l.loadResults(function(){n.init()})},loadFacets:function(e){c("Getting Facets"),a.call(t.elastic_search_url(),r.create({facets:t.settings.facets,query:r.matchAllQuery}),function(t){o.sidebar.html(s.facets({facets:t.facets})),c("Facets Loaded"),e&&e()})},loadResults:function(e){c("Loading Results"),a.call(t.elastic_search_url(),r.create(n.serialize()),function(t){o.results.html(s.results({results:t})),c("Results Loaded"),e&&e()})}};var u;return d={init:function(e){l.init(e)},loadFacets:l.loadFacets,templates:l.Templates}}(window.jQuery);(function(e){e.fn.serializeObject=function(){var t=this,a={},i={},n={validate:/^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,key:/[a-zA-Z0-9_]+|(?=\[\])/g,push:/^$/,fixed:/^\d+$/,named:/^[a-zA-Z0-9_]+$/};return this.build=function(e,t,a){return e[t]=a,e},this.push_counter=function(e){return void 0===i[e]&&(i[e]=0),i[e]++},e.each(e(this).serializeArray(),function(){if(n.validate.test(this.name)){for(var i,s=this.name.match(n.key),o=this.value,r=this.name;void 0!==(i=s.pop());)r=r.replace(RegExp("\\["+i+"\\]$"),""),i.match(n.push)?o=t.build([],t.push_counter(r),o):i.match(n.fixed)?o=t.build([],i,o):i.match(n.named)&&(o=t.build({},i,o));a=e.extend(!0,a,o)}}),a}})(jQuery),Object.deepExtend=function(e,t){for(var a in t)t[a]&&t[a].constructor&&t[a].constructor===Object?(e[a]=e[a]||{},arguments.callee(e[a],t[a])):e[a]=t[a];return e};var deepExtend=function(){if(1>arguments.length||"object"!=typeof arguments[0])return!1;if(2>arguments.length)return arguments[0];var e,t,a,i,n=arguments[0],s=Array.prototype.slice.call(arguments,1);return s.forEach(function(s){if("object"==typeof s)for(e in s)if(void 0!==s[e]){if(a=n[e],t=s[e],t===n)continue;if("object"!=typeof t||null===t){n[e]=t;continue}if("object"!=typeof a){i=Array.isArray(t)?[]:{},n[e]=deepExtend(i,t);continue}i=Array.isArray(t)?Array.isArray(a)?a:[]:Array.isArray(a)?{}:a,n[e]=deepExtend(i,t)}}),n};